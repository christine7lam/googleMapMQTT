<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Tyco Fraud Detection</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <style>
        .active {box-shadow: 0 1px 10px green;}
        .danger {box-shadow: 0 1px 10px red;}
    </style>
</head>
<body>
    <nav class="navbar navbar-inverse">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="/">Tyco On</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Tyco Fraud Detection UI</h2>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default swipe-panel">
                    <div class="panel-heading">
                        <h4>Card Identification Frauds Control Center</h4>
                    </div>
                    <div class="panel-body" id="locations">
                        <div class="btn btn-danger reset" id="reset">Reset</div>
                        <div class="btn btn-danger">Disconnect from MQTT</div>
                        <p />
                        <div class="row">

                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        jQuery(function($) {
            var socket = io.connect();
            var $locations = $("#locations .row");
            var $reset = $("#reset");

            //Data
            var demoArray = [];
            var eventArray = [];

            //Topics
            var demoT = "demo_discovery";
            var eventT = "discovery_events";

            //Date
            var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

            socket.on('json', function(data) {
                if(data.topic === demoT)
                    parseDemo(data);
                if(data.topic === eventT)
                    parseEvents(data);
            });
            /**** EVENTS *******/
            $reset.on('click', function(){
                demoArray = [];
                eventArray =[];
                $locations.html("");
            });
            /**** FUNCTIONS *****/
            function parseEvents(data){
                var event = JSON.parse(clearString(data.msgString.toString()));
                isDup = detectFraud(eventArray, event);
                if(!isDup){
                    $(".panel."+event.event.assetKey+ " ul.event").html(
                        "<li>Asset Type: <b>"+event.sourceEvents[0].key+"</b></li>"+
                                "<li>User ID: <b>"+event.sourceEvents[0].userId+"</b></li>"+
                                "<li>Date Time: <b>"+event.sourceEvents[0].dateTime+"</b></li>"
                    )
                    $(".panel."+event.event.assetKey).addClass("active");
                }

            }
            function parseDemo(data){
                var demo = JSON.parse(clearString(data.msgString.toString()));
                //demoArray = detectDuplicate(demo);
                isDup = detectDuplicate(demoArray, demo, data.topic);
                if(isDup) alert("Duplicate: Location "+demo.asset.key+ " has already been added");
                if(!isDup) {
                    $locations.append("<div class='col-md-6'>" +
                            "<div class='panel panel-default "+demo.asset.key+ "'>" +
                            "<div class='panel-heading'>" +
                            demo.asset.name +
                            "</div>" +
                            "<div class='panel-body'>" + demo.asset.key +
                            "<br />" + clearString(data.msgString.toString()) +
                            "<ul class='event'></ul>" +
                            "</div>" +
                            "</div></div>"
                    );
                }
            }
            function clearString(input){
                var output = input.toString().replace(/(\r\n|\n|\r)/gm,"");
                output = output.replace(/\s+/g,"");
                output = output.replace(/\\\//g, "");
                try {
                    output = JSON.parse(output);
                }catch(exception){
                    alert('Error while parsing JSON : check json format');
                }
                return output;
            }
            function detectDuplicate(array, newVal, topic) {
                var isDup = false;
                var compareString = null;
                if(topic === demoT)
                    compareString = newVal.asset.key;
                if(topic === eventT)
                    compareString = event.sourceEvents[0].userId;

                if (array !== null && array.length > 0) {
                    for (i = 0, len = array.length; i < len; ++i)
                    {
                        if (array[i].key === compareString) {
                            isDup = true;
                            return isDup;
                        }
                    }
                }
                array.push({
                    key: compareString,
                    value: newVal
                });
                return isDup;
            }
            function detectFraud(array, newVal) {
                var isDup = false;
                var compUser = null;
                var compKey = null;
                var dateTime = null;
                var danger = null;

                    compUser = newVal.sourceEvents[0].userId;
                    compKey = newVal.sourceEvents[0].sourcekey;
                    dateTime = newVal.sourceEvents[0].dateTime;

                //alert(compUser + "key: "+compKey+" date: "+dateTime);

                if (array !== null && array.length > 0) {
                    for (i = 0, len = array.length; i < len; ++i)
                    {
                        if (array[i].key !== compKey && array[i].user === compUser) {
                            isDup = true;
                            danger = calInterval(array[i].dateTime, dateTime);
                            if(danger){
                                $(".panel."+compKey).removeClass("active");
                                $(".panel."+compKey).addClass("danger");
                                $(".panel."+array[i].key).removeClass("active");
                                $(".panel."+array[i].key).addClass("danger");
                                array[i] = newVal;
                                alert("WARNING: FRAUD!!! Please investigate");
                            }
                            return isDup;
                        }else{
                            array[i] = newVal;
                        }
                    }
                }
                array.push({
                    key: compKey,
                    user: compUser,
                    dateTime: dateTime,
                    value: newVal
                });
                return isDup;
            }
            function calInterval(dateOld, dateNew){
                var isDanger = false;
                var getOldDate = dateOld.split("T");
                var getNewDate = dateNew.split("T");
                var sameDay = false;
                var warning = false;

                var pOldDate = getOldDate[0].split("-");
                var pNewDate = getNewDate[0].split("-");

                if(getOldDate[0] === getNewDate[0])
                    sameDay = true;

                if(sameDay){
                    var millLapsed = getDateMill(pOldDate, getOldDate[1]) - getDateMill(pNewDate, getNewDate[1]);
                    warning = calTimeLapsed(millLapsed);
                   // alert("MILLLAPSED: "+millLapsed);
                }
                if(warning){
                    //alert("WARNING: FRAUD!!! Please investigate");
                    isDanger = true;
                }
                return isDanger;
            }
            function getDateMill(dateArray, fulltime){
                var utcTime = "Z";
                //var fulltime = fulltime.substring(0, fulltime.length-1);
                var fulltime = fulltime.split(".");
                //alert("FULLTIME: "+fulltime);
                var pubDate = new Date(dateArray[0],parseInt(dateArray[1])-1,dateArray[2]);
                //alert("PUB: "+Date.parse(pubDate));

                var pdatemill = Date.parse(days[pubDate.getDay()] + ", " + pubDate.getDate() + " " + months[pubDate.getMonth()] + " " + pubDate.getFullYear() + " " + fulltime[0]+' GMT');
                //alert("PDATEMILL: "+pdatemill);
                return pdatemill;
            }
            function calTimeLapsed(seconds) {
                var isFraud = false;
                var numdays = Math.floor((seconds % 31536000) / 86400);
                var numhours = Math.floor(((seconds % 31536000) % 86400) / 3600);
                var numminutes = Math.floor((((seconds % 31536000) % 86400) % 3600) / 60);
                if(numminutes < 2)
                    isFraud = true;

                return isFraud;
            }

        });
    </script>
</body>
</html>