<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Tyco Fraud Detection</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
</head>
<body>
    <nav class="navbar navbar-inverse">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="/">Tyco On</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Tyco Fraud Detection UI</h2>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default swipe-panel">
                    <div class="panel-heading">
                        <h4>Card Identification Frauds Control Center</h4>
                    </div>
                    <div class="panel-body" id="locations">
                        <div class="btn btn-danger">Reset</div>
                        <div class="btn btn-danger">Disconnect from MQTT</div>
                        <p />
                        <div class="row">

                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        jQuery(function($) {
            var socket = io.connect();
            var $locations = $("#locations .row");

            //Data
            var demoArray = [];
            var eventArray = [];

            socket.on('json', function(data) {
                if(data.topic === 'demo_discovery')
                    parseDemo(data);
                if(data.topic === 'discovery_events')
                    parseEvents(data);
            });

            /**** FUNCTIONS *****/
            function parseEvents(data){

            }
            function parseDemo(data){
                var demo = JSON.parse(clearString(data.msgString.toString()));
                //demoArray = detectDuplicate(demo);
                isDup = detectDuplicate(demoArray, demo);
                if(isDup) alert("Duplicate: Location "+demo.asset.key+ " has already been added");
                if(!isDup) {
                    $locations.append("<div class='col-md-6'>" +
                            "<div class='panel panel-default "+demo.asset.key+ "'>" +
                            "<div class='panel-heading'>" +
                            demo.asset.name +
                            "</div>" +
                            "<div class='panel-body'>" + demo.asset.key +
                            "<br />" + clearString(data.msgString.toString()) +
                            "</div>" +
                            "</div></div>"
                    );
                }
            }
            function clearString(input){
                var output = input.toString().replace(/(\r\n|\n|\r)/gm,"");
                output = output.replace(/\s+/g,"");
                output = output.replace(/\\\//g, "");
                try {
                    output = JSON.parse(output);
                }catch(exception){
                    alert('Error while parsing JSON : check json format');
                }
                return output;
            }
            function detectDuplicate(array, newVal) {
                var isDup = false;
                if (array !== null && array.length > 0) {
                    for (i = 0, len = array.length; i < len; ++i)
                    {
                        if (array[i].key === newVal.asset.key) {
                            isDup = true;
                            return isDup;
                        }
                    }
                }
                array.push({
                    key: newVal.asset.key,
                    value: newVal
                });
                return isDup;
            }
        });
    </script>
</body>
</html>